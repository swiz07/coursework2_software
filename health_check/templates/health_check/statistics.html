{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Department Statistics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet">

  <!-- Shared Navbar CSS -->
  <link rel="stylesheet" href="{% static 'health_check/css/navbar.css' %}">
  <!-- Statistics Page CSS -->
  <link rel="stylesheet" href="{% static 'health_check/css/statistics.css' %}">
</head>
<body>
  {% include "homenavbar.html" %}

  <div class="main-content container py-4">
    <h4>Department Statistics</h4>

    <!-- Session Picker -->
    <div class="mb-3">
      <label class="form-label me-2">Select Session:</label>
      <select class="form-select w-auto d-inline-block"
              onchange="location='?session='+this.value+'&department={{ selected_department }}&team={{ selected_team }}'">
        {% for sess in sessions %}
          <option
            value="{{ sess.session_id }}"
            {% if current_session and sess.session_id == current_session.session_id %}selected{% endif %}>
            Session {{ forloop.counter }}{% if sess.session_status == "active" %} (Active){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Department Picker -->
    <div class="mb-4">
      <label class="form-label me-2">Select Department:</label>
      <select class="form-select w-auto d-inline-block"
              {% if not is_manager %}disabled{% endif %}
              onchange="location='?session={{ current_session.session_id }}&department='+encodeURIComponent(this.value)+'&team={{ selected_team }}'">
        {% if is_manager %}
          <option value="all" {% if selected_department == "all" %}selected{% endif %}>
            Overall
          </option>
        {% endif %}
        {% for d in departments %}
          <option value="{{ d }}" {% if d == selected_department %}selected{% endif %}>
            {{ d }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="row gx-4 gy-4">
      <!-- Teams Sidebar -->
      <div class="col-md-3">
        <div class="list-group team-list">
          {% for id,name in team_list %}
            <a href="?session={{ current_session.session_id }}&department={{ selected_department }}&team={{ id }}"
               class="list-group-item list-group-item-action{% if id|stringformat:'s' == selected_team %} active{% endif %}"
               data-team="{{ id }}">
              {{ name }}
            </a>
          {% endfor %}
        </div>
      </div>

      <!-- Charts Area -->
      <div class="col-md-9">
        <div class="row gx-3">
          <!-- Ring Gauges -->
          <div class="col-lg-4">
            <div class="card-panel text-center p-3">
              <h5 id="ring-title">â€”</h5>
              <div id="ring-container" class="d-flex justify-content-around">
                {% for clr in colors %}
                  <div class="ring text-center" data-color="{{ clr }}">
                    <canvas width="80" height="80"></canvas>
                    <div class="ring-label">0</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Pie Chart -->
          <div class="col-lg-4">
            <div class="card-panel p-3">
              <canvas id="pieChart"></canvas>
            </div>
          </div>

          <!-- Progress KPI -->
          <div class="col-lg-4">
            <div class="card-panel text-center p-3">
              <h6>Progress Over Time</h6>
              <div id="progressKPI" class="display-5 text-success">0%</div>
            </div>
          </div>
        </div>

        <!-- Bar Chart -->
        <div class="card-panel mt-4 p-3">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap and Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Inline data injection -->
  <script>
    window.TEAM_DATA    = {{ team_data_json|safe }};
    window.DEFAULT_TEAM = "{{ selected_team }}";
    window.COLORS       = {
      red:   '#db4b4b',
      amber: '#f2c94c',
      green: '#27ae60'
    };
  </script>
  <!-- External chart logic -->
  <script src="{% static 'health_check/js/statistics-charts.js' %}"></script>
</body>
</html>
